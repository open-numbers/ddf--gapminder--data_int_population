info:
    id: ddf--gapminder--population
    author:  semio<prairy.long@gmail.com> at Gapminder
    version: 0.1
    base:
        - &gm_pop open-numbers/ddf--gapminder--population_historic
        - &un_pop harpalshergill/ddf--unpop--wpp_population
        - &gm_geo open-numbers/ddf--gapminder--geo_entity_domain

config:
    recipes_dir: ./

include:
    - pop_by_age_country_year.yml
    - pop_by_age_gender_country_year.yml
    - pop_by_country_year.yml
    - pop_by_global_year.yml


ingredients:
    - id: gm-entities-geo
      dataset: *gm_geo
      key: geo
      value: "*"
    - id: unpop-entities-age
      dataset: *un_pop
      key: age1yearinterval
      value: "*"
    - id: unpop-entities-gender
      dataset: *un_pop
      key: gender
      value: "*"
    - id: gm-concepts-geo
      dataset: *gm_geo
      key: concept
      value: "*"
    - id: unpop-concepts-entities
      dataset: *un_pop
      key: concept
      value: "*"
      filter:
          concept:
              - age
              - gender
              - sourceurl
    - id: gm-geo-synonym
      dataset: *gm_geo
      key: country, synonym
      value: "*"

cooking:
    entities:
        - procedure: translate_header
          ingredients:
              - unpop-entities-age
          options:
              dictionary:
                  age1yearinterval: age
          result: unpop-entities-age-final
        - procedure: serve
          ingredients:
              - gm-entities-geo
              - unpop-entities-gender
        - procedure: serve
          ingredients:
              - unpop-entities-age-final
          options:
              no_keep_sets: true
    concepts:
        - procedure: extract_concepts
          ingredients:
              - unpop-datapoints-pop-by-country-age-gender-aligned
          options:
              include_keys: true
              overwrite:
                  year: time
                  age: entity_domain
                  gender: entity_domain
          result: extracted_concepts
        - procedure: merge
          ingredients:
              - extracted_concepts
              - gm-concepts-geo
              - unpop-concepts-entities
          options:
              deep: true
          result: concepts_final
        - procedure: serve
          ingredients:
              - concepts_final
